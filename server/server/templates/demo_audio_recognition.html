<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recorderjs/0.1.0/recorder.min.js"></script>
</head>
<body>
    <div id="status">NOT RECORDING</div>
    <hr>
    <button id="listenButton">Listen</button>
    <hr>
    <div id="transcript"></div>

    <script>  // Stream audio to server via websocket
        // Create a Socket.IO instance
        const socket = io('http://localhost:5000');
        // const socket = io.connect(null, {port: 5000, rememberTransport: false});

        // Get the microphone
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
          var audioContext = new AudioContext();
          var audioInput = audioContext.createMediaStreamSource(stream);

          var bufferSize = 2048;
          var scriptNode = audioContext.createScriptProcessor(bufferSize, 1, 1);

          scriptNode.onaudioprocess = function(audioProcessingEvent) {
            var inputBuffer = audioProcessingEvent.inputBuffer;
            var inputData = inputBuffer.getChannelData(0);

            // Convert the float audio data to 16-bit PCM
            var outputData = new Int16Array(inputData.length);
            for (var i = 0; i < inputData.length; i++) {
              outputData[i] = inputData[i] * 32767;
            }

            // Emit the audio data to the server
            socket.emit('demo_audio_stream', outputData);
          };

          audioInput.connect(scriptNode);
          scriptNode.connect(audioContext.destination);
        })
        .catch(function(err) {
          console.error('Error accessing audio input: ' + err);
        });
    </script>

    <script>  // Display the transcript received from the server
        socket.on('transcript', (data) => {
            if (data.transcript === 'endOfStream') {
                const fullTranscript = chunks.join('');
                document.getElementById('transcript').textContent = fullTranscript;
                chunks = []; // Reset chunks for future use
            } else {
                chunks.push(data.transcript);
            }
        });
    </script>

    <script> // Update recording status
      socket.onmessage = function(event) {
        const message = event.data;

        if (message === 'start_recording') {
          console.log('got start_recording');
          changeStatus('RECORDING');
        } else if (message === 'stop_recording') {
          console.log('got stop_recording');
          changeStatus('NOT RECORDING');
        }
      };

      function changeStatus(text) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = text;
      }
    </script>

    <script> // listen
      const listenButton = document.getElementById('listenButton');
      listenButton.addEventListener('click', function() {
        console.log('clicked listen');
        socket.emit('listen');
      });
    </script>
</body>
</html>
